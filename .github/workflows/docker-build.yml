name: docker-build

on:
  workflow_call:
    inputs:
      # ===== Registry =====
      registry:
        description: "Registry: dockerhub | ghcr | gitlab | ecr"
        type: string
        default: "ghcr"

      registry-type:
        description: "ECR: private | public"
        type: string
        default: "private"

      ghcr-owner:
        description: "Owner/org for GHCR images (e.g. nserbin)"
        type: string
        default: ""

      repository-name:
        description: "Image name (without registry/owner). Example: freedium-web"
        type: string
        required: true

      docker-tag:
        description: "Tag for Docker Image"
        type: string
        default: "latest"

      docker-architecture:
        description: "Platforms for buildx, ex: linux/amd64,linux/arm64"
        type: string
        default: "linux/amd64"

      # ===== Build inputs =====
      build-context:
        description: "Build context path (relative to WORKDIR). Default '.'"
        type: string
        default: "."

      dockerfile-path:
        description: "Dockerfile directory path OR file path (relative to WORKDIR). Default 'Dockerfile'"
        type: string
        default: "Dockerfile"

      # ===== Source selection =====
      clone-source:
        description: "If true, clone source-repo and build from it"
        type: boolean
        default: false

      source-repo:
        description: "ORG/REPO to clone when clone-source=true"
        type: string
        default: ""

      source-ref:
        description: "Git ref to checkout when clone-source=true"
        type: string
        default: "main"

      # ===== Dockerfile resolution =====
      dockerfile-mode:
        description: "auto | source | fallback"
        type: string
        default: "auto"

      fallback-dockerfile:
        description: "Fallback Dockerfile path"
        type: string
        default: ""

      # ===== Lint controls =====
      linter-fail:
        description: "Do not fail workflow on lint errors"
        type: boolean
        default: false

      linter-verbose:
        description: "Hadolint verbose"
        type: boolean
        default: false

      linter-format:
        description: "Hadolint format"
        type: string
        default: "tty"

      # ===== Misc =====
      node-version:
        description: "Node version build-arg"
        type: string
        default: "20"

      aws-access-keys:
        type: boolean
        default: false

      aws-access-role:
        type: boolean
        default: false

    secrets:
      DOCKERHUB_USERNAME:
        required: false
      DOCKERHUB_TOKEN:
        required: false
      GITLAB_USERNAME:
        required: false
      GITLAB_PASSWORD:
        required: false
      AWS_ACCESS_KEY_ID:
        required: false
      AWS_SECRET_ACCESS_KEY:
        required: false
      AWS_ROLE_ARN:
        required: false
      AWS_ROLE_NAME:
        required: false
      REGION:
        required: false

permissions:
  contents: read
  packages: write

jobs:
  docker:
    runs-on: ubuntu-latest

    outputs:
      image_ref: ${{ steps.build.outputs.image_ref }}
      resolved_dockerfile: ${{ steps.resolve.outputs.dockerfile }}
      resolved_context: ${{ steps.resolve.outputs.context }}

    steps:
      - name: Checkout caller repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clone source repository
        if: ${{ inputs.clone-source }}
        run: |
          set -euo pipefail
          rm -rf src
          git clone "https://github.com/${{ inputs.source-repo }}.git" src
          cd src
          git checkout "${{ inputs.source-ref }}"

      - name: Resolve build context + dockerfile
        id: resolve
        run: |
          set -euo pipefail

          WORKDIR="."
          [ "${{ inputs.clone-source }}" = "true" ] && WORKDIR="src"

          DF_IN="${{ inputs.dockerfile-path }}"
          [ -d "${WORKDIR}/${DF_IN}" ] && DF_PATH="${WORKDIR}/${DF_IN}/Dockerfile" || DF_PATH="${WORKDIR}/${DF_IN}"

          CONTEXT_PATH="${WORKDIR}/${{ inputs.build-context }}"

          SOURCE_EXISTS=false
          [ -f "$DF_PATH" ] && SOURCE_EXISTS=true

          MODE="${{ inputs.dockerfile-mode }}"
          FALLBACK="${{ inputs.fallback-dockerfile }}"

          if [ "$MODE" = "source" ] && [ "$SOURCE_EXISTS" != true ]; then
            echo "Dockerfile not found in source"
            exit 1
          fi

          if [ "$MODE" = "fallback" ]; then
            DF_PATH="$FALLBACK"
          fi

          if [ "$MODE" = "auto" ] && [ "$SOURCE_EXISTS" != true ]; then
            DF_PATH="$FALLBACK"
          fi

          echo "context=$CONTEXT_PATH" >> $GITHUB_OUTPUT
          echo "dockerfile=$DF_PATH" >> $GITHUB_OUTPUT

      - name: Lint Dockerfile
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: ${{ steps.resolve.outputs.dockerfile }}
          no-fail: ${{ inputs.linter-fail }}
          verbose: ${{ inputs.linter-verbose }}
          format: ${{ inputs.linter-format }}

      - name: Set registry login variables
        id: registry
        run: |
          if [ "${{ inputs.registry }}" = "dockerhub" ]; then
            echo "registry=docker.io" >> $GITHUB_OUTPUT
            echo "username=${{ secrets.DOCKERHUB_USERNAME }}" >> $GITHUB_OUTPUT
            echo "password=${{ secrets.DOCKERHUB_TOKEN }}" >> $GITHUB_OUTPUT
          elif [ "${{ inputs.registry }}" = "ghcr" ]; then
            echo "registry=ghcr.io" >> $GITHUB_OUTPUT
            echo "username=${{ github.actor }}" >> $GITHUB_OUTPUT
            echo "password=${{ secrets.GITHUB_TOKEN }}" >> $GITHUB_OUTPUT
          elif [ "${{ inputs.registry }}" = "gitlab" ]; then
            echo "registry=registry.gitlab.com" >> $GITHUB_OUTPUT
            echo "username=${{ secrets.GITLAB_USERNAME }}" >> $GITHUB_OUTPUT
            echo "password=${{ secrets.GITLAB_PASSWORD }}" >> $GITHUB_OUTPUT
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to registry
        uses: docker/login-action@v3
        if: ${{ inputs.registry != 'ecr' }}
        with:
          registry: ${{ steps.registry.outputs.registry }}
          username: ${{ steps.registry.outputs.username }}
          password: ${{ steps.registry.outputs.password }}

      - name: Build & push image
        id: build
        run: |
          set -euo pipefail

          TAG="${{ inputs.docker-tag }}"
          NAME="${{ inputs.repository-name }}"
          REG="${{ inputs.registry }}"

          if [ "$REG" = "ghcr" ]; then
            OWNER="${{ inputs.ghcr-owner }}"
            [ -z "$OWNER" ] && OWNER="${{ github.repository_owner }}"
            IMAGE="ghcr.io/${OWNER}/${NAME}:${TAG}"
          elif [ "$REG" = "dockerhub" ]; then
            IMAGE="${{ steps.registry.outputs.username }}/${NAME}:${TAG}"
          else
            IMAGE="${NAME}:${TAG}"
          fi

          echo "Building image: $IMAGE"
          echo "image_ref=$IMAGE" >> $GITHUB_OUTPUT

          docker buildx build \
            --platform "${{ inputs.docker-architecture }}" \
            --file "${{ steps.resolve.outputs.dockerfile }}" \
            --build-arg NODE_VERSION="${{ inputs.node-version }}" \
            --provenance=false \
            --push \
            -t "$IMAGE" \
            "${{ steps.resolve.outputs.context }}"
