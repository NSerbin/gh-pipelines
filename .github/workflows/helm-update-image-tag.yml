name: Reusable - Helm Update Values

on:
  workflow_call:
    inputs:
      charts_repo:
        description: "Repo destino con charts (ORG/REPO)"
        type: string
        required: true
      charts_ref:
        description: "Branch a modificar"
        type: string
        default: "main"
      chart_path:
        description: "Path al chart dentro del repo (ej: charts/freedium)"
        type: string
        required: true
      commit_message:
        description: "Mensaje base del commit"
        type: string
        default: "chore(helm): update values"

      updates_json:
        description: |
          JSON array de updates. Ej:
          [
            {"file":"values.yaml","path":".image.tag","value":"sha-xxxx","type":"str"},
            {"file":"values.yaml","path":".caddy.image.tag","value":"sha-xxxx","type":"str"}
          ]
        type: string
        required: true

      update_app_version:
        description: "Si true, setea Chart.yaml appVersion = app_version_value"
        type: boolean
        default: false
      app_version_value:
        description: "Valor a setear en appVersion cuando update_app_version=true"
        type: string
        default: ""

    secrets:
      SYNC_APP_ID:
        required: true
      SYNC_APP_PRIVATE_KEY:
        required: true

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Mint GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SYNC_APP_ID }}
          private-key: ${{ secrets.SYNC_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout charts repo
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.charts_repo }}
          ref: ${{ inputs.charts_ref }}
          token: ${{ steps.app-token.outputs.token }}
          fetch-depth: 0

      - name: Install yq + jq
        run: |
          set -euo pipefail
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version
          jq --version

      - name: Apply updates_json to values files
        env:
          CHART_DIR: ${{ inputs.chart_path }}
          UPDATES: ${{ inputs.updates_json }}
        run: |
          set -euo pipefail

          echo "$UPDATES" | jq -e . >/dev/null

          echo "$UPDATES" | jq -c '.[]' | while read -r item; do
            file="$(echo "$item" | jq -r '.file')"
            path="$(echo "$item" | jq -r '.path')"
            value="$(echo "$item" | jq -r '.value')"
            type="$(echo "$item" | jq -r '.type // "str"')"

            target="${CHART_DIR}/${file}"
            test -f "$target" || { echo "File not found: $target"; exit 1; }

            echo "Updating $target: $path = $value ($type)"

            case "$type" in
              str)
                VALUE="$value" yq -i "$path = strenv(VALUE)" "$target"
                ;;
              bool)
                if [ "$value" = "true" ] || [ "$value" = "false" ]; then
                  VALUE="$value" yq -i "$path = (env(VALUE) == \"true\")" "$target"
                else
                  echo "Invalid bool value for $path: $value"
                  exit 1
                fi
                ;;
              int)
                VALUE="$value" yq -i "$path = (env(VALUE) | tonumber)" "$target"
                ;;
              *)
                echo "Unknown type '$type' for $path"
                exit 1
                ;;
            esac
          done

      - name: Update Chart.yaml appVersion (optional)
        if: ${{ inputs.update_app_version }}
        env:
          NEW_VER: ${{ inputs.app_version_value }}
        run: |
          set -euo pipefail
          test -n "$NEW_VER" || { echo "app_version_value is required when update_app_version=true"; exit 1; }

          CHART="${{ inputs.chart_path }}/Chart.yaml"
          test -f "$CHART" || { echo "Chart.yaml not found: $CHART"; exit 1; }

          VER="$NEW_VER" yq -i '.appVersion = strenv(VER)' "$CHART"

      - name: Commit & push if changed
        run: |
          set -euo pipefail

          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to commit."
            exit 0
          fi

          git config user.name  "sync-repos-automation[bot]"
          git config user.email "sync-repos-automation[bot]@users.noreply.github.com"

          git add "${{ inputs.chart_path }}" || true
          git commit -m "${{ inputs.commit_message }}"
          git push origin "${{ inputs.charts_ref }}"
